<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>视唱练听小练习</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- VexFlow（五线谱渲染） -->
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.3/build/vexflow-min.js"></script>

  <!-- 图标 -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen flex flex-col items-center p-4 md:p-8">

  <!-- 隐藏的原生 audio（关键：src 就是 exercise.mp3） -->
  <audio id="audio-element" src="exercise.mp3"></audio>

  <!-- 标题 -->
  <header class="w-full max-w-4xl text-center mb-8">
    <h1 class="text-4xl font-bold text-indigo-700 mb-2">视唱练听小练习</h1>
    <p class="text-gray-600">
      步骤：听题目 → 在五线谱上输入 5 个音符 → 提交查看得分
    </p>
  </header>

  <!-- 主卡片 -->
  <main class="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6 md:p-8 flex flex-col gap-8">

    <!-- 1. 音频播放区 -->
    <section class="border-b border-gray-200 pb-6">
      <h2 class="text-2xl font-semibold text-indigo-600 mb-4 flex items-center gap-2">
        <i class="fas fa-music"></i> 题目播放
      </h2>

      <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
        <div class="text-left">
          <div class="text-gray-700 mb-1">当前练习：前 5 个音听写</div>
          <div class="text-xs text-gray-500">
            （只播放 mp3 的前 3.1 秒 ≈ 前 5 个音）
          </div>
        </div>

        <div class="flex gap-3 items-center">
          <button id="play-btn"
                  class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg flex items-center gap-2
                         hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
            <i class="fas fa-play"></i> 播放题目
          </button>

          <button id="pause-btn" disabled
                  class="bg-gray-600 text-white px-5 py-2.5 rounded-lg flex items-center gap-2
                         hover:bg-gray-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
            <i class="fas fa-pause"></i> 暂停
          </button>
        </div>
      </div>

      <!-- 进度条（只显示 0~前 5 个音这一段） -->
      <progress id="audio-progress" value="0" max="100"
                class="w-full h-2 mt-4 rounded"></progress>
    </section>

    <!-- 2. 五线谱 + 音符输入 -->
    <section class="flex flex-col gap-6">
      <h2 class="text-2xl font-semibold text-indigo-600 flex items-center gap-2">
        <i class="fas fa-pencil-alt"></i> 你的答案（五线谱）
      </h2>

      <!-- 五线谱区域 -->
      <div id="staff-user"
           class="w-full h-64 bg-gray-50 border border-gray-200 rounded-lg flex items-center justify-center">
      </div>

      <p class="text-sm text-gray-500 text-center">
        点击下面的按钮，将音符依次加入五线谱中（最多 5 个音）。
      </p>

      <!-- 音符按钮 -->
      <div class="flex flex-wrap gap-2 justify-center">
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="C4">Do (C4)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="D4">Re (D4)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="E4">Mi (E4)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="F4">Fa (F4)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="G4">Sol (G4)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="A4">La (A4)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="B4">Si (B4)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="C5">Do (C5)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="D5">Re (D5)</button>
        <button class="note-btn bg-indigo-500 text-white px-4 py-2 rounded-lg"
                data-note="C#5">Ci (C#5)</button>
      </div>

      <!-- 操作按钮 -->
      <div class="flex justify-center gap-4 mt-2">
        <button id="clear-btn"
                class="bg-red-500 text-white px-6 py-2 rounded-lg flex items-center gap-2
                       hover:bg-red-600 transition">
          <i class="fas fa-trash"></i> 清空输入
        </button>
        <button id="submit-btn"
                class="bg-green-500 text-white px-6 py-2 rounded-lg flex items-center gap-2
                       hover:bg-green-600 transition">
          <i class="fas fa-check"></i> 提交答案
        </button>
      </div>
    </section>

    <!-- 3. 评分与正确答案 -->
    <section class="border-t border-gray-200 pt-6 text-center">
      <h2 class="text-2xl font-semibold text-indigo-600 flex items-center justify-center gap-2 mb-4">
        <i class="fas fa-graduation-cap"></i> 评分与答案
      </h2>

      <div id="score-display" class="text-3xl font-bold text-gray-700 mb-2">
        得分：-- / 100
      </div>

      <div id="detail-text" class="text-sm text-gray-500 mb-4">
        共需输入 5 个音。
      </div>

      <!-- 正确答案（文字） -->
      <div id="correct-answer-text" class="text-lg text-gray-700 mb-3 hidden">
        正确答案：<span id="answer-notes"></span>
      </div>

      <!-- 正确答案五线谱 -->
      <div id="staff-correct"
           class="w-full h-52 bg-gray-50 border border-gray-200 rounded-lg flex items-center justify-center hidden">
      </div>

      <button id="reset-btn"
              class="mt-5 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
        <i class="fas fa-rotate-right"></i> 再做一次
      </button>
    </section>
  </main>

  <footer class="mt-8 text-gray-500 text-center text-sm">
    © 2025 视唱练听练习小站
  </footer>

  <!-- 逻辑脚本 -->
  <script>
    // ========== 1. 配置区域 ==========
    const CLIP_DURATION = 3.1;   // 只听前 3.1 秒 ≈ 前五个音
    const CORRECT_NOTES = ["D5", "B4", "C#5", "D5", "B4"];
    const MAX_NOTES = 5;

    // ========== 2. 全局变量 ==========
    const VF = Vex.Flow;
    let userNotes = [];

    const audioEl = document.getElementById("audio-element");
    const playBtn = document.getElementById("play-btn");
    const pauseBtn = document.getElementById("pause-btn");
    const progressBar = document.getElementById("audio-progress");

    // 简单防止多次 setTimeout
    let clipTimer = null;

    // ========== 3. 五线谱绘制 ==========
    function noteToVexKey(note) {
      const m = note.match(/^([A-G])(#|b)?(\d)$/);
      if (!m) return null;
      const step = m[1].toLowerCase();
      const acc = m[2] || "";
      const oct = m[3];
      return { key: `${step}${acc}/${oct}`, acc };
    }

    function drawStaff(containerId, notesArray) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      const width = container.clientWidth || 600;
      const height = container.clientHeight || 160;

      const renderer = new VF.Renderer(container, VF.Renderer.Backends.SVG);
      renderer.resize(width, height);
      const context = renderer.getContext();

      const stave = new VF.Stave(10, 20, width - 20);
      stave.addClef("treble");
      stave.setContext(context).draw();

      if (!notesArray || notesArray.length === 0) return;

      const staveNotes = notesArray.map(n => {
        const nk = noteToVexKey(n);
        if (!nk) return null;
        const note = new VF.StaveNote({
          clef: "treble",
          keys: [nk.key],
          duration: "q"
        });
        if (nk.acc) note.addModifier(new VF.Accidental(nk.acc), 0);
        return note;
      }).filter(Boolean);

      if (!staveNotes.length) return;

      const voice = new VF.Voice({
        num_beats: staveNotes.length,
        beat_value: 4
      });
      voice.addTickables(staveNotes);

      new VF.Formatter().joinVoices([voice]).format([voice], width - 80);
      voice.draw(context, stave);
    }

    function refreshUserStaff() {
      drawStaff("staff-user", userNotes);
    }

    // ========== 4. 音频播放（用原生 audio） ==========
    playBtn.addEventListener("click", () => {
      if (clipTimer) {
        clearTimeout(clipTimer);
        clipTimer = null;
      }
      audioEl.currentTime = 0;
      audioEl.play();
      playBtn.disabled = true;
      pauseBtn.disabled = false;

      // 限制只播放前 CLIP_DURATION 秒
      clipTimer = setTimeout(() => {
        audioEl.pause();
        audioEl.currentTime = 0;
        playBtn.disabled = false;
        pauseBtn.disabled = true;
      }, CLIP_DURATION * 1000);
    });

    pauseBtn.addEventListener("click", () => {
      audioEl.pause();
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      if (clipTimer) {
        clearTimeout(clipTimer);
        clipTimer = null;
      }
    });

    // 更新进度条（只按 CLIP_DURATION 计算）
    audioEl.addEventListener("timeupdate", () => {
      const t = audioEl.currentTime;
      const ratio = Math.min(t / CLIP_DURATION, 1);
      progressBar.value = ratio * 100;
    });

    audioEl.addEventListener("ended", () => {
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      progressBar.value = 0;
      if (clipTimer) {
        clearTimeout(clipTimer);
        clipTimer = null;
      }
    });

    // ========== 5. 音符输入 ==========
    const noteButtons = document.querySelectorAll(".note-btn");
    const clearBtn = document.getElementById("clear-btn");
    const submitBtn = document.getElementById("submit-btn");
    const resetBtn = document.getElementById("reset-btn");

    noteButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const note = btn.dataset.note;
        if (userNotes.length >= MAX_NOTES) {
          alert("本题只需要输入 5 个音符，已达到上限。");
          return;
        }
        userNotes.push(note);
        refreshUserStaff();
      });
    });

    clearBtn.addEventListener("click", () => {
      userNotes = [];
      refreshUserStaff();
      document.getElementById("score-display").textContent = "得分：-- / 100";
      document.getElementById("detail-text").textContent = "共需输入 5 个音。";
      document.getElementById("correct-answer-text").classList.add("hidden");
      document.getElementById("staff-correct").classList.add("hidden");
    });

    // ========== 6. 提交 & 评分 ==========
    const scoreDisplay = document.getElementById("score-display");
    const detailText = document.getElementById("detail-text");
    const correctAnswerText = document.getElementById("correct-answer-text");
    const answerNotesSpan = document.getElementById("answer-notes");

    submitBtn.addEventListener("click", () => {
      if (userNotes.length < MAX_NOTES) {
        alert(`请先输入 ${MAX_NOTES} 个音符再提交（当前只输入了 ${userNotes.length} 个）。`);
        return;
      }

      let correctCount = 0;
      for (let i = 0; i < MAX_NOTES; i++) {
        if (userNotes[i] === CORRECT_NOTES[i]) {
          correctCount++;
        }
      }
      const score = correctCount * 20;

      scoreDisplay.textContent = `得分：${score} / 100`;
      detailText.textContent = `共 5 个音，你答对了 ${correctCount} 个。`;

      answerNotesSpan.textContent = CORRECT_NOTES.join("  ");
      correctAnswerText.classList.remove("hidden");

      drawStaff("staff-correct", CORRECT_NOTES);
      document.getElementById("staff-correct").classList.remove("hidden");
    });

    resetBtn.addEventListener("click", () => {
      userNotes = [];
      refreshUserStaff();
      scoreDisplay.textContent = "得分：-- / 100";
      detailText.textContent = "共需输入 5 个音。";
      correctAnswerText.classList.add("hidden");
      document.getElementById("staff-correct").classList.add("hidden");
      progressBar.value = 0;
      audioEl.pause();
      audioEl.currentTime = 0;
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      if (clipTimer) {
        clearTimeout(clipTimer);
        clipTimer = null;
      }
    });

    // ========== 7. 初始化 ==========
    window.addEventListener("load", () => {
      refreshUserStaff();
    });
  </script>
</body>
</html>
